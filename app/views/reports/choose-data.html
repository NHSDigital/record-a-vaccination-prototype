{% extends 'layout.html' %}

{% set pageName = "Choose data" %}

{% set currentSection = "reports" %}


{% block beforeContent %}
  {{ backLink({
    href: "/reports/choose-site",
    text: "Back"
  }) }}
{% endblock %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {% if error %}
        {{ errorSummary({
          titleText: "There is a problem",
          errorList: [error]
        }) }}
      {% endif %}

      <form action="/reports/update-data" method="post" novalidate="true">


        {% set patientsHtml %}

          {% set items = [] %}
          {% for option in data.patientDataOptions %}
            {% set items = (items.push({
              text: option,
              value: option
            }), items) %}
          {% endfor %}

          {{ checkboxes({
            idPrefix: "patient-data",
            name: "patientDataToReport",
            fieldset: {
              legend: {
                text: "Patient data"
              }
            },
            values: data.patientDataToReport,
            items: items
          }) }}
        {% endset %}

        {% set staffHtml %}

          {% set items = [] %}
          {% for option in data.staffDataOptions %}
            {% set items = (items.push({
              text: option,
              value: option
            }), items) %}
          {% endfor %}

          {{ checkboxes({
            idPrefix: "staff-data",
            name: "staffDataToReport",
            fieldset: {
              legend: {
                text: "Staff data"
              }
            },
            values: data.staffDataToReport,
            items: items
          }) }}
        {% endset %}

        {% set sitesHtml %}

          {% set items = [] %}
          {% for option in data.locationDataOptions %}
            {% set items = (items.push({
              text: option,
              value: option
            }), items) %}
          {% endfor %}

          {{ checkboxes({
            idPrefix: "site-data",
            name: "siteDataToReport",
            fieldset: {
              legend: {
                text: "Site data"
              }
            },
            values: data.siteDataToReport,
            items: items
          }) }}
        {% endset %}

        {% set consentAndEligibilityHtml %}

          {% set items = [] %}
          {% for option in data.consentAndEligibilityDataOptions %}
            {% set items = (items.push({
              text: option,
              value: option
            }), items) %}
          {% endfor %}

          {{ checkboxes({
            idPrefix: "consent-and-eligibility-data",
            name: "consentAndEligibilityDataToReport",
            fieldset: {
              legend: {
                text: "Consent and eligibility data"
              }
            },
            values: data.consentAndEligibilityDataToReport,
            items: items
          }) }}
        {% endset %}

        {% set vaccinationHtml %}

          {% set items = [] %}
          {% for option in data.vaccinationDataOptions %}
            {% set items = (items.push({
              text: option,
              value: option
            }), items) %}
          {% endfor %}

          {{ checkboxes({
            idPrefix: "vaccination-data",
            name: "vaccinationDataToReport",
            fieldset: {
              legend: {
                text: "Vaccination data"
              }
            },
            values: data.vaccinationDataToReport,
            items: items
          }) }}
        {% endset %}

        {{ checkboxes({
          idPrefix: "data",
          name: "data",
          attributes: {
            id: "data-fields"
          },
          errorMessage: {
            text: error.text
          } if error,
          fieldset: {
            legend: {
              text: "Choose data",
              isPageHeading: true,
              classes: "nhsuk-fieldset__legend--l"
            }
          },
          values: data.data,
          items: [
            {
              value: "Patients",
              text: "Patients",
              conditional: {
                html: patientsHtml
              }
            },
            {
              value: "Staff",
              text: "Staff",
              conditional: {
                html: staffHtml
              }
            },
            {
              value: "Sites",
              text: "Sites",
              conditional: {
                html: sitesHtml
              }
            },{
              value: "Consent and eligibility",
              text: "Consent and eligibility",
              conditional: {
                html: consentAndEligibilityHtml
              }
            },{
              value: "Vaccination",
              text: "Vaccination",
              conditional: {
                html: vaccinationHtml
              }
            }
          ]
        }) }}

        {{ button({
          "text": "Continue"
        }) }}
      </form>


    </div>
  </div>

<script>
  function checkOrUncheckChildren(event) {

    const checkboxClicked = event.target

    const checkboxesControlled = document.getElementById(checkboxClicked.getAttribute('aria-controls')).querySelectorAll('input[type=checkbox')

    for (checkbox of checkboxesControlled) {
      checkbox.checked = checkboxClicked.checked
    }
  }

  const parentCheckboxes = document.getElementById('data-fields').querySelectorAll('input[type=checkbox][aria-controls]')

  for (checkbox of parentCheckboxes) {
    checkbox.addEventListener('click', checkOrUncheckChildren)
  }

  function uncheckParentIfAllUnchecked(event) {

    const checkboxClicked = event.target

    const parentGroup = checkboxClicked.closest('.nhsuk-checkboxes__conditional')

    const parentGroupId = parentGroup.getAttribute('id')

    const parentCheckbox = document.querySelector(`input[aria-controls=${parentGroupId}]`)

    const allCheckboxesInGroup = parentGroup.querySelectorAll('input[type=checkbox]')

    let checkboxStatuses = []

    for (checkbox of allCheckboxesInGroup) {
      checkboxStatuses.push(checkbox.checked)
    }

    if (!checkboxStatuses.includes(true)) {
      // Uncheck parent
      parentCheckbox.click()
    }
  }

  const childCheckboxes = document.getElementById('data-fields').querySelectorAll('.nhsuk-checkboxes__conditional input[type=checkbox]')

  for (checkbox of childCheckboxes) {
    checkbox.addEventListener('click', uncheckParentIfAllUnchecked)
  }


</script>

{% endblock %}
