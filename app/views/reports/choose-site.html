{% extends 'layout.html' %}

{% set pageName = ("Choose sites" if sites else "Choose organisations") %}

{% set currentSection = "reports" %}

{% block beforeContent %}
  {{ backLink({
    href: "/reports/choose-vaccines",
    text: "Back"
  }) }}
{% endblock %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      <form action="/reports/choose-data" method="post">

        {% set items = [] %}

        {% if ((sites | length) > 2) or ((organisations | length) > 2) %}

          {% set items = (items.push({
            text: "All " + ((sites|length) if sites else (organisations|length)) + " " + ("sites" if sites else "organisations"),
            value: "all",
            attributes: {
              "data-select-all": "true"
            }
          }), items) %}

          {% set items = (items.push({
            divider: "or"
          }), items) %}

        {% endif %}

        {% for siteOrOrg in ((sites if sites else organisations) | sort(false, false, "name")) %}

          {% if siteOrOrg.address %}
            {% set hint = {
              text: siteOrOrg.address.line1 + ", " + siteOrOrg.address.town + ", " + siteOrOrg.address.postcode
            } %}
          {% endif %}

          {% set items = (items.push({
            value: siteOrOrg.id,
            text: siteOrOrg.name + " (" + siteOrOrg.id + ")",
            hint: hint
          }), items) %}
        {% endfor %}

        {{ checkboxes({
          idPrefix: "sites-to-report",
          name: "siteIdsToReport",
          fieldset: {
            legend: {
              text: pageName,
              classes: "nhsuk-fieldset__legend--l",
              isPageHeading: true
            }
          },
          values: data.siteIdsToReport,
          items: items
        }) }}


        {{ button({
          text: "Continue"
        }) }}

      </form>

    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Select all checkbox
      const selectAllCheckbox = document.querySelector('input[data-select-all]');

      // All row checkboxes (everything starting with select- except select-all)
      const otherCheckboxes = Array.from(
        document.querySelectorAll('input:not([data-select-all])')
      );

      // Click on header toggles all rows
      selectAllCheckbox.addEventListener('change', () => {

        otherCheckboxes.forEach(cb => {
          cb.checked = selectAllCheckbox.checked;
        });
        selectAllCheckbox.indeterminate = false;
      });

      // Click on rows updates header state
      otherCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          const allChecked = otherCheckboxes.every(c => c.checked);
          const noneChecked = otherCheckboxes.every(c => !c.checked);

          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
        });
      });
    });
  </script>

{% endblock %}

