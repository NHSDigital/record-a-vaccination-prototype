{% extends 'layout.html' %}

{% set pageName = "Choose vaccine" %}

{% set currentSection = "vaccines" %}

{% block beforeContent %}
  {{ backLink({
    href: "/vaccines/choose-site",
    text: "Back"
  }) }}
{% endblock %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">
      <form action="/vaccines/add-batch" method="post" novalidate="true">
        {% set items = [] %}

        {% for vaccine in (vaccinesEnabled | sort(false, false, "name")) %}
          {% if vaccine.products %}
            {% set productItems = [] %}
            {% for vaccineProduct in (vaccine.products) %}
              {% set productItems = (productItems.push({
                value: vaccineProduct.name,
                text: vaccineProduct.name
              }), productItems) %}
            {% endfor %}

            {% set conditionalHtml %}
              {{ radios({
                "idPrefix": "vaccineProduct" + vaccine.name,
                "name": "vaccineProduct",
                "fieldset": {
                  "legend": {
                    "text": "Vaccine product"
                  }
                },
                "items": productItems,
                value: data.vaccineProduct
              }) }}
            {% endset %}
          {% endif %}

          {% set items = (items.push({
            value: vaccine.name,
            text: (vaccine.name | capitaliseFirstLetter),
            conditional: {
              html: conditionalHtml
            } if vaccine.products
          }), items) %}
        {% endfor %}

        {{ radios({
          "idPrefix": "vaccine",
          "name": "vaccine",
          "fieldset": {
            "legend": {
              "text": pageName,
              "size": "l",
              "isPageHeading": true
            }
          },
          value: data.vaccine,
          errorMessage: {
            text: vaccineError
          } if vaccineError,
          "items": items
        }) }}


        {{ button({
          "text": "Continue"
        }) }}
      </form>

      {% if (vaccinesThatCanBeRequested | length) > 0 %}

        {% set detailsHtml %}
          {% set requestableItems = [] %}
          {% for vaccine in (vaccinesThatCanBeRequested | sort) %}

            {% set requestableItems = (requestableItems.push({
              value: vaccine,
              text: (vaccine | capitaliseFirstLetter)
            }), requestableItems) %}
          {% endfor %}

          <form action="/vaccines/enable" method="post">

          <p>You can now use Record a vaccination for national {{ vaccinesThatCanBeRequested | join(" and ") }} vaccinations.</p>

          <p>Pharmacies are paid automatically by the NHS Business Services Authority.</p>

            {{ checkboxes({
              name: "vaccinesAdded",
              idPrefix: "vaccines-added",
              fieldset: {
                legend: {
                  text: "Vaccine",
                  classes: "nhsuk-fieldset__legend--s"
                }
              },
              items: requestableItems
            }) }}

            {{ button({
              text: "Add",
              classes: "nhsuk-button--secondary nhsuk-u-margin-bottom-0"
            }) }}
          </form>
        {% endset %}

        {{ details({
          summaryText: "Add other vaccines",
          html: detailsHtml
        }) }}

      {% endif %}

    </div>
  </div>
{% endblock %}
