{% extends 'layout.html' %}

{% set pageName = "Why are you giving them the vaccine?" %}

{% set currentSection = "vaccinate" %}

{% block beforeContent %}
  {{ backLink({ href: "/record-vaccinations/batch" }) }}
{% endblock %}

{% set CovidEligibilityOptions = [
  "Resident in a care home",
  "Aged 75 and over, and not in a care home",
  "Immunosuppressed"
] %}

{% set RSVEligibilityOptions = [
  "Aged 75 to 80",
  "Pregnant"
] %}

{% set NationalFluEligibilityOptions = [
  "Based on age",
  "Healthcare worker",
  "Pregnant",
  "In a clinical risk group",
  "Resident in a care home",
  "Carer",
  "Social care worker",
  "Household contact of someone immunosuppressed"
] %}

{% set londonFluEligibilityOptions = [
  "Homeless",
  "Gypsy, Roma and Traveller communities",
  "Sex worker",
  "Learning disability",
  "Mental health condition",
  "In a detained estate or in contact with justice system",
  "Migrant or asylum seeker",
  "Victim of modern slavery",
  "Drug or alcohol dependency",
  "Another health exclusion group based on local need",
  "Healthcare worker not covered by national criteria"
] %}

{% block content %}
  <div class="nhsuk-grid-row">
    <div class="nhsuk-grid-column-two-thirds">

      {% if (errors | length) > 0 %}
        {{ errorSummary({
          titleText: "There is a problem",
          errorList: errors
        }) }}
      {% endif %}

      <form action="/record-vaccinations/answer-eligibility" method="post" novalidate>

        {% if data.vaccine == "COVID-19" %}
          {% set eligibilityOptions = CovidEligibilityOptions %}
        {% elif data.vaccine == "flu" %}
          {% set eligibilityOptions = NationalFluEligibilityOptions %}
        {% elif data.vaccine == "RSV" %}
          {% set eligibilityOptions = RSVEligibilityOptions %}
        {% else %}
          {% set eligibilityOptions = [] %}
        {% endif %}

        {% set items = [] %}
        {% for option in eligibilityOptions %}
          {% set items = (items.push({
            text: option,
            value: option,
            checked: (data.eligibility | arrayOrStringIncludes(option))
            }), items) %}
        {% endfor %}

        {% call fieldset({
          legend: {
            text: "Why are you giving them the vaccine?",
            classes: "nhsuk-fieldset__legend--l",
            isPageHeading: true
          }
        }) %}

          {% if data.vaccine == "flu" %}

            {% set londonFluItems = [] %}
            {% for option in londonFluEligibilityOptions %}
              {% set londonFluItems = (londonFluItems.push({
                text: option,
                value: option,
                checked: (data.eligibility | arrayOrStringIncludes(option))
                }), londonFluItems) %}
            {% endfor %}

            {% set londonFluHtml %}
              {{ radios({
                idPrefix: "eligibility-2",
                name: "eligibility",
                items: londonFluItems
              }) }}
            {% endset %}

            {% set items = (items.push({
              divider: "or"
            }), items) %}

            {% set items = (items.push({
              text: "London flu service",
              value: "london-flu",
              conditional: {
                html: londonFluHtml
              }
            }), items) %}

          {% endif %}

          {{ radios({
            idPrefix: "eligibility",
            name: "eligibility",
            items: items
          }) }}

        {% endcall %}

        {{ button({
          text: "Continue"
        })}}
      </form>

    </div>
  </div>

{% endblock %}

